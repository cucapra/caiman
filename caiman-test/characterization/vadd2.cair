version 0.0.2

type u32;
type i32;
type array<i32>;
event %event0;
buffer_space %buffspace;
native_value %ni32 : i32;
native_value %nu32 : u32;
native_value %na32 : array<i32>;

function @iadd(i32, i32) -> i32;
function @empty() -> array<i32>;
function @split(array<i32>) -> [i32, array<i32>];
function @prepend(i32, array<i32>) -> array<i32>;

function @vadd(array<i32>, array<i32>, u32) -> array<i32>;
function @vadd2(array<i32>, array<i32>, array<i32>, u32) -> array<i32>;

external-cpu-pure[impl @add] %iadd(i32, i32) -> i32;
external-cpu-pure[impl @empty] %empty() -> array<i32>;
external-cpu-pure[impl @split] %split(array<i32>) -> [i32, array<i32>];
external-cpu-pure[impl @prepend] %prepend(i32, array<i32>) -> array<i32>;

value[impl default @vadd] %vadd(
%v1: array<i32>,
%v2: array<i32>,
%length: u32) -> array<i32> {
    %empty_t = call @empty();
    %empty = extract %empty_t 0;

    %v1_head_tail_t = call @split(%v1);
    %v1_head = extract %v1_head_tail_t 0;
    %v1_tail = extract %v1_head_tail_t 1;

    %v2_head_tail_t = call @split(%v2);
    %v2_head = extract %v2_head_tail_t 0;
    %v2_tail = extract %v2_head_tail_t 1;

    %added_t = call @add(%v1_head, %v2_head);
    %added = extract %added_t 0;

    %neg1 = constant %ni32 -1;
    %length_m1_t = call @add(%length, %neg1);
    %length_m1 = extract %length_m1_t 0;
    %rec_t = call @vadd(%v1_tail, %v2_tail, %length_m1);
    %rec = extract %rec_t 0;

    %built_t = call @prepend(%added, %rec);
    %built = extract %built_t 0;

    %result = select %length %built %empty;
    return %result;
}

value[impl default @vadd] %vadd2(
%v1: array<i32>,
%v2: array<i32>,
%v3: array<i32>,
%length: u32) -> array<i32> {
    %temp_t = call @vadd(%v1, %v2, %length);
    %temp = extract %temp_t 0;
    %result_t = call @vadd(%temp, %v3, %length);
    %result = extract %result_t 0;
    return %result;
}

timeline %time(%e : %event0) -> %event0 {
    return %e;
}

spatial %space(%bs : %buffspace) -> %buffspace {
    return %bs;
}

schedule<none-have, none-have>
[value $val = %vadd, timeline $time = %time, spatial $space = %space]
%vadd_main(%v1l : %na32, %v2l : %na32, length : %ni32) -> %na32 {
    %x_loc = alloc-temporary local i64;
    %y_loc = alloc-temporary local i64;
    %n1_loc = alloc-temporary local i64;
    %n2_loc = alloc-temporary local i64;
    %res_loc = alloc-temporary local i64;

    local-do-builtin node($val.%x)() -> %x_loc;
    local-do-builtin node($val.%y)() -> %y_loc;

    local-do-external %add node($val.%n1_t)(%x_loc, %y_loc) -> %n1_loc;
    local-do-external %add node($val.%n2_t)(%x_loc, %n1_loc) -> %n2_loc;
    local-do-external %add node($val.%res_t)(%n1_loc, %n2_loc) -> %res_loc;
    
    %res_val = read-ref i64 %res_loc;
    return %res_val;
}

schedule<none-have, none-have>
[value $val = %vadd, timeline $time = %time, spatial $space = %space]
%vadd_main() -> %na32 {

}

pipeline "main" = %foo_main;